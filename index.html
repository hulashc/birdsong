<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Birdsong Manifold</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; background: #000; color: #fff; font-family: sans-serif; }
    canvas { display: block; }

    #ui {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      pointer-events: none;
    }
    #label {
      font-size: 12px;
      color: #00ffcc;
      letter-spacing: 3px;
      text-transform: uppercase;
    }
    #playBtn {
      pointer-events: all;
      padding: 10px 32px;
      background: transparent;
      color: #00ffcc;
      border: 2px solid #00ffcc;
      border-radius: 30px;
      font-size: 15px;
      cursor: pointer;
      letter-spacing: 2px;
      transition: background 0.2s;
    }
    #playBtn:hover { background: rgba(0,255,204,0.15); }

    #overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.75);
      cursor: pointer;
      z-index: 10;
    }
    #overlay span {
      font-size: 22px;
      color: #00ffcc;
      border: 2px solid #00ffcc;
      padding: 14px 36px;
      border-radius: 30px;
      letter-spacing: 3px;
    }
  </style>
</head>
<body>

<div id="overlay"><span>&#9654; CLICK TO START</span></div>

<div id="ui">
  <div id="label">Raven &mdash; Spatiotemporal Acoustic Manifold</div>
  <button id="playBtn" style="display:none">&#9646;&#9646; PAUSE</button>
</div>

<script type="importmap">
  { "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }}
</script>
<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

  // --- Renderer ---
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  document.body.appendChild(renderer.domElement);

  // --- Scene / Camera ---
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.01, 100);
  camera.position.set(0, 0, 3);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.autoRotate = true;
  controls.autoRotateSpeed = 0.5;
  controls.enableDamping = true;

  // --- Web Audio API for amplitude ---
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const audio = new Audio('./birds/raven.mp3');
  audio.loop = true;
  audio.crossOrigin = 'anonymous';

  const source = audioCtx.createMediaElementSource(audio);
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  source.connect(analyser);
  analyser.connect(audioCtx.destination);
  const freqData = new Uint8Array(analyser.frequencyBinCount);

  function getAmplitude() {
    analyser.getByteFrequencyData(freqData);
    const avg = freqData.reduce((a, b) => a + b, 0) / freqData.length;
    return avg / 128; // normalised 0..~2
  }

  // --- State ---
  let started = false;
  let paused = false;
  let frameIndex = 0;

  // --- Overlay: start everything ---
  const overlay = document.getElementById('overlay');
  const playBtn = document.getElementById('playBtn');

  overlay.addEventListener('click', () => {
    audioCtx.resume();
    audio.play();
    overlay.style.display = 'none';
    playBtn.style.display = 'inline-block';
    started = true;
  }, { once: true });

  // --- Pause / Resume button ---
  playBtn.addEventListener('click', () => {
    if (!paused) {
      audio.pause();
      paused = true;
      playBtn.innerHTML = '&#9654; RESUME';
    } else {
      audioCtx.resume();
      audio.play();
      paused = false;
      playBtn.innerHTML = '&#9646;&#9646; PAUSE';
    }
  });

  // --- Load JSON ---
  const data = await fetch('./birdsong_data.json').then(r => r.json());
  const tracers = [];

  for (const [species, coords] of Object.entries(data)) {
    const points = coords.map(([x, y, z]) => new THREE.Vector3(x, y, z));
    const total = points.length;

    // Dim full path
    const trailGeo = new THREE.BufferGeometry().setFromPoints(points);
    scene.add(new THREE.Line(trailGeo,
      new THREE.LineBasicMaterial({ color: 0x004444, transparent: true, opacity: 0.25 })
    ));

    // Moving dot
    const dot = new THREE.Mesh(
      new THREE.SphereGeometry(0.018, 12, 12),
      new THREE.MeshBasicMaterial({ color: 0x00ffcc })
    );
    scene.add(dot);

    // Glowing tail
    const tailLength = 40;
    const tailPositions = new Float32Array(tailLength * 3);
    const tailGeo = new THREE.BufferGeometry();
    tailGeo.setAttribute('position', new THREE.BufferAttribute(tailPositions, 3));
    scene.add(new THREE.Line(tailGeo,
      new THREE.LineBasicMaterial({ color: 0x00ffcc, transparent: true, opacity: 0.6 })
    ));

    tracers.push({ points, total, dot, tailGeo, tailPositions, tailLength, index: 0 });
  }

  // --- Animate ---
  function animate() {
    requestAnimationFrame(animate);
    controls.update();

    if (started && !paused) {
      const amplitude = getAmplitude();

      // Base speed 0.3 frames/tick, scales up with amplitude
      // Silent = barely moves, loud singing = fast movement
      const speed = 0.3 + amplitude * 2.5;

      for (const t of tracers) {
        t.index = (t.index + speed) % t.total;
        const i = Math.floor(t.index);
        const pos = t.points[i];

        // Scale dot size with amplitude
        const scale = 1 + amplitude * 1.5;
        t.dot.scale.set(scale, scale, scale);
        t.dot.position.copy(pos);

        // Shift tail
        for (let j = t.tailLength - 1; j > 0; j--) {
          t.tailPositions[j * 3]     = t.tailPositions[(j - 1) * 3];
          t.tailPositions[j * 3 + 1] = t.tailPositions[(j - 1) * 3 + 1];
          t.tailPositions[j * 3 + 2] = t.tailPositions[(j - 1) * 3 + 2];
        }
        t.tailPositions[0] = pos.x;
        t.tailPositions[1] = pos.y;
        t.tailPositions[2] = pos.z;
        t.tailGeo.attributes.position.needsUpdate = true;
      }
    }

    renderer.render(scene, camera);
  }

  animate();

  window.addEventListener('resize', () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });
</script>
</body>
</html>
